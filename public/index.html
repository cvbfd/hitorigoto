<!DOCTYPE HTML>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Hitorigoto</title>
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/grid.css">
    <link rel="stylesheet" href="css/general.css">
    <link rel="stylesheet" href="css/jquery.autocomplete.css">
    <style type="text/css">
        header {
            padding-top: 25px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 20px;
        }

        #logo {
            font-size: 20px;
        }

        header nav ul li {
            float: left;
            margin-top: 12px;
        }

        header nav ul li a {
            display: block;
            padding: 5px 15px;
            border-right: 1px solid #eee;
            font-size: 1.52em;
            font-family: Georgia, "Times New Roman", Times, serif;
            text-decoration: none;
        }

        header nav ul li a:hover {
            background-color: #eee;
            border-right: 1px solid #ccc;
            text-shadow: -1px -1px 0px #fff;
        }

        header nav ul li.last a {
            border-right: none;
        }

        #grid div {
            text-align: center;
        }

        #grid div > .col {
            border-bottom: 1px solid #ccc;
            padding: 10px 0px;
            outline: 1px solid #eee;
        }

        h2 {
            border-bottom: 1px dashed #ccc;
            margin-top: 15px;
        }

        footer {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            padding: 4px 0px;
        }
    </style>
</head>
<body>
<div class="row">
    <header>
        <div id="logo" class="col width_16">Hitorigoto</div>
    </header>
</div>
<div class="row">
    <div class="row">
        <div class="width_16 align_center">
            <div id="tweet_box"></div>
            <span id="login"></span>
        </div>
    </div>
</div>

</body>
<!--
<script src="http://platform.twitter.com/anywhere.js?id=fkyxoOHIxFyvm3lxGyVEQ&v=1" type="text/javascript"></script>
-->
<script type="text/javascript" src="js/lib/jquery-1.6.2.min.js"></script>
<script type="text/javascript" src="js/lib/underscore.js"></script>
<script type="text/javascript" src="js/lib/jquery.autocomplete.js"></script>
<script type="text/javascript" src="js/lib/js-model-0.10.1.js"></script>

<script type="text/javascript">

    var User = new Model('user', function() {
        this.persistence(Model.localStorage);
        this.extend({
            find_by_screen_name: function(screen_name) {
                return this.detect(function() {
                    return this.attr("screen_name") === screen_name
                })
            }
        })
    });

    var getFriends = function(screen_name, cursor) {
        var friends_url = 'http://api.twitter.com/1/statuses/friends.json?screen_name=ninoseki&cursor=' + cursor + '&callback=?';

        $.getJSON(friends_url, {}, function(friends) {
            for (var i = 0, len = friends.length; i < len; i++) {
                if (User.find_by_screen_name((friends[i].screen_name)) === undefined) {
                    var user = new User({screen_name : frieds[i].screen_name});
                    user.save();
                    console.log(friends[i].screen_name);
                }
            }

            if (friends.next_cursor !== undefined) {
                getFriend(screen_name, friends.next_cursor);
            }
        });
    }

    var autoCompleteName = function() {
        $("#tweet_boxx textarea").keyup(function(event) {
            if ($(this).hasClass("completable") || $("#tweet_box textarea").val()[0] != "@") {
                return;
            }
            $(this).addClass("completable");      // 1度しか発生しないように印を付ける
            var self = this;

            var data = User.map(function() {
                return this.attr("screen_name");
            });

            $(this).autocomplete(data)
                    .result(function(event, item) {      // callbackイベントを設定
                        $(self).val($(self).val() + " "); // @screen_nameの後に半角スペースを1つ置く
                        $(self).unbind();                 // 自動補完のBindを外す
                    });
            $(this).keydown();                    // "@"が既に入力されているので、能動的にkeydownして補完させる
        });
    };


    $(function() {
        User.load(function() {
        });

        twttr.anywhere(function (T) {
            T("#tweet_box").tweetBox({
                height: 50,
                width: 520
            });
        });

        twttr.anywhere(function (T) {
            if (T.isConnected()) {
                var current_user = T.currentUser;
                var screen_name = currentUser.data('screen_name');
                getFriends('screen_name', "-1");

            } else {
                T("#login").connectButton();
            }
        });

    });


</script>
</html>